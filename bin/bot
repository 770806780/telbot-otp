#!/usr/bin/env node

const Telegraf = require('telegraf');

const { Registration, UserChat } = require('../models');

require('dotenv').config();

const bot = new Telegraf(process.env.BOT_TOKEN);

bot.start(async (ctx) => {
  const userChat = await UserChat.findOne({ where: { chat_id: ctx.chat.id } });
  if (userChat) {
    ctx.reply('Welcome!');
  } else {
    ctx.reply('Welcome!\nSilakan melakukan registrasi dengan menggunakan perintah:\n/reg <token>');
  }
});

bot.command('reg', async (ctx) => {
  const userChat = await UserChat.findOne({ where: { chat_id: ctx.chat.id } });
  if (userChat) {
    ctx.reply('Anda sudah terdaftar.');
    return;
  }
  const splitted = ctx.message.text.split(/\s+/);
  if (splitted.length < 2) {
    ctx.reply('Anda harus memasukkan token registrasi untuk mendaftar.\nGunakan perintah:\n/reg <token>');
  } else {
    const token = splitted[1];
    const reg = await Registration.findOne({ where: { token } });
    if (reg) {
      const userChatNew = await UserChat.findOne({ where: { user_id: reg.user_id } });
      if (userChatNew) {
        userChat.chat_id = ctx.chat.id;
        await userChat.save();
      } else {
        await UserChat.create({ user_id: reg.user_id, chat_id: ctx.chat.id });
      }
      await reg.destroy();
      ctx.reply('Berhasil mendaftar.');
    } else {
      ctx.reply('Token tidak ditemukan.');
    }
  }
});

bot.launch();
